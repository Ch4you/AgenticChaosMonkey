name: CI

on:
  push:
  pull_request:

jobs:
  tests:
    runs-on: ubuntu-latest
    env:
      CHAOS_LLM_HEALTH_SKIP: "true"
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[dev]"
          python -m pip install "langchain-core>=0.1.0,<0.4.0" "openai>=1.0.0,<2.0.0"

      - name: Health check (live)
        run: |
          agent-chaos health-check --plan examples/plans/travel_agent_chaos.yaml --mode live

      - name: Production validation (SLA + reports)
        run: |
          agent-chaos run examples/plans/travel_agent_chaos.yaml --mock-server \
            --repeat 10 --repeat-concurrency 2 --repeat-delay 0.1 \
            --report-json logs/agent_summary.json \
            --report-csv logs/agent_summary.csv \
            --report-md logs/agent_summary.md \
            --report-pdf logs/agent_summary.pdf \
            --failure-artifacts-dir logs/failures \
            --failure-artifacts-zip logs/failures.zip \
            --failure-artifacts-tar logs/failures.tar.gz \
            --acceptance-report reports/acceptance.md \
            --sla-success-rate 0.8

      - name: Run tests
        run: |
          pytest
      - name: Run SDK integration tests
        run: |
          pytest tests/integration/test_sdk_middleware_langchain.py tests/integration/test_sdk_middleware_openai_responses.py -q

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: agent-chaos-artifacts
          path: |
            logs/
            reports/
